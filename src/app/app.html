<div class="app-container">
  <header class="header">
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
      <div>
        <h1>🎨 Dithering Studio</h1>
        <p class="subtitle">Advanced Creative Error Diffusion</p>
      </div>
      <!-- Test Achievement Button -->
      <button class="btn-test-achievement" (click)="testAchievementNotification()" title="Test Achievement">
        🏆 Test
      </button>
    </div>
  </header>
  
  <!-- Hidden file input (always present) -->
  <input #fileInput type="file" accept="image/*" (change)="onFileSelected($event)" style="display: none;">
  
  <!-- Show Waifu Button (cuando está oculta) -->
  @if (waifuPositionService.position() === 'hidden') {
    <button class="show-waifu-btn" (click)="waifuPositionService.showWaifu()" title="Show Waifu">
      <span class="waifu-emoji">◠‿◠</span>
      <span class="btn-text">Show Waifu</span>
    </button>
  }

  <div class="main-content">
    @if (!imageLoaded()) {
      <div class="upload-section">
        <div class="upload-area" (click)="triggerFileInput()">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <h2>Click to Upload Image</h2>
          <p>or drag and drop your image here</p>
          <p class="file-info">Supports JPG, PNG, GIF</p>
        </div>
      </div>
    }

    @if (imageLoaded()) {
      <div class="editor-section">
        <!-- CRT Waifu Monitor (draggable floating mode) -->
        <app-crt-waifu 
          [state]="waifuState()"
          [spriteSheet]="waifuSpriteUrl()"
          [framesPerRow]="3"
          [totalFrames]="6"
          (click)="onWaifuClick()"
          (spriteUploaderRequested)="showSpriteUploader.set(true)">
        </app-crt-waifu>
        
        <div class="editor-content">
          <div class="controls-panel">
            <div class="panel-header">
              <h3>Controls</h3>
              <button class="btn-secondary" (click)="resetControls()">Reset</button>
            </div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>Style</span>
            </label>
            <select class="select-input" [ngModel]="selectedAlgorithm()" (ngModelChange)="selectedAlgorithm.set($event); onAlgorithmChange()">
              @for (category of categoryKeys; track category) {
                <optgroup [label]="category">
                  @for (algo of algorithmsByCategory[category]; track algo.id) {
                    <option [value]="algo.id">{{ algo.name }}</option>
                  }
                </optgroup>
              }
            </select>
          </div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>Palette</span>
            </label>
            <div style="display: flex; gap: 8px;">
              <select class="select-input" style="flex: 1;" [ngModel]="selectedPalette()" (ngModelChange)="selectedPalette.set($event); onPaletteChange()">
                @for (palette of palettes(); track palette.id) {
                  <option [value]="palette.id">{{ palette.name }}</option>
                }
              </select>
              <button class="btn-icon" (click)="togglePaletteCreator()" title="Create Custom Palette">+</button>
            </div>
            <!-- Palette Color Preview -->
            <div class="palette-preview">
              @for (color of getSelectedPaletteColors(); track $index) {
                <div class="palette-preview-color" [style.backgroundColor]="color" [title]="color"></div>
              }
            </div>
          </div>

          <div class="divider"></div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>Scale</span>
              <span class="control-value">{{ scale() }}</span>
            </label>
            <input type="range" min="1" max="5" step="0.1" class="slider" [ngModel]="scale()" (ngModelChange)="scale.set($event); onControlChange()">
          </div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>Contrast</span>
              <span class="control-value">{{ contrast() }}</span>
            </label>
            <input type="range" min="0" max="100" step="1" class="slider" [ngModel]="contrast()" (ngModelChange)="contrast.set($event); onControlChange()">
          </div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>Midtones</span>
              <span class="control-value">{{ midtones() }}</span>
            </label>
            <input type="range" min="0" max="100" step="1" class="slider" [ngModel]="midtones()" (ngModelChange)="midtones.set($event); onControlChange()">
          </div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>Highlights</span>
              <span class="control-value">{{ highlights() }}</span>
            </label>
            <input type="range" min="0" max="100" step="1" class="slider" [ngModel]="highlights()" (ngModelChange)="highlights.set($event); onControlChange()">
          </div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>Blur</span>
              <span class="control-value">{{ blur() }}</span>
            </label>
            <input type="range" min="0" max="5" step="1" class="slider" [ngModel]="blur()" (ngModelChange)="blur.set($event); onControlChange()">
          </div>

          <div class="divider"></div>

          <div class="action-buttons">
            <button class="btn-secondary" (click)="togglePresetManager()" style="width: 100%;">
              💾 Presets
            </button>
            <button class="btn-secondary" (click)="showSpriteUploader.set(true)" style="width: 100%;">
              🎨 Custom Waifu Sprite
            </button>
            
            <div class="divider"></div>
            
            <!-- Achievement & Gallery Buttons -->
            <div class="button-group" style="width: 100%;">
              <button class="btn-secondary btn-group-left" (click)="toggleAchievements()" title="View Achievements">
                <span>🏆 Level {{ achievementService.userProgress().level }}</span>
              </button>
              <button class="btn-secondary btn-group-right" (click)="toggleGallery()" title="Open Gallery">
                <span>🖼️ Gallery ({{ galleryService.gallery().length }})</span>
              </button>
            </div>
            
            <button class="btn-secondary" (click)="saveToGallery()" [disabled]="!imageLoaded() || processing()" style="width: 100%;">
              💾 Save to Gallery
            </button>
            
            <div class="divider"></div>
            
            <div class="button-group" style="width: 100%;">
              <button class="btn-secondary btn-group-left" (click)="downloadImage()" [disabled]="processing()">
                @if (processing()) {
                  <span>⏳</span>
                } @else {
                  <span>💾 PNG</span>
                }
              </button>
              <button class="btn-secondary btn-group-right" 
                      [class.active]="gifStudioMode()"
                      (click)="toggleGifStudioMode()" 
                      [disabled]="processing()">
                @if (gifStudioMode()) {
                  <span>✨ GIF Mode</span>
                } @else {
                  <span>🎬 GIF Studio</span>
                }
              </button>
            </div>
            
            <!-- Composition Mode Button -->
            <button class="btn-secondary" 
                    [class.active]="compositionMode()"
                    (click)="toggleCompositionMode()" 
                    [disabled]="processing()"
                    style="width: 100%;">
              @if (compositionMode()) {
                <span>✨ Layers Active</span>
              } @else {
                <span>🎨 Composition Layers</span>
              }
            </button>
            
            <button class="btn-secondary" (click)="triggerFileInput()">
              🖼️ New Image
            </button>
          </div>
        </div>
        <!-- Fin controls-panel -->

        <div class="canvas-area" [class.gif-mode]="gifStudioMode()" [class.composition-mode]="compositionMode()">
          
          <!-- Mode Navigation Bar -->
          <div class="mode-navigation-bar">
            <button 
              class="mode-btn" 
              [class.active]="!gifStudioMode() && !compositionMode()"
              (click)="exitAllModes()"
              title="Image Preview & Dithering">
              <span class="icon">🖼️</span>
              <span class="label">Preview</span>
            </button>
            
            <button 
              class="mode-btn" 
              [class.active]="compositionMode()"
              (click)="toggleCompositionMode()"
              title="Layer Composition Mode">
              <span class="icon">🎨</span>
              <span class="label">Composition</span>
            </button>
            
            <button 
              class="mode-btn" 
              [class.active]="gifStudioMode()"
              (click)="toggleGifStudioMode()"
              title="GIF Animation Studio">
              <span class="icon">🎬</span>
              <span class="label">GIF Studio</span>
            </button>
          </div>
          
          <!-- GIF Studio Panel + Effect Editor (side by side) -->
          @if (gifStudioMode()) {
            <div class="gif-studio-container">
              <!-- GIF Studio Options -->
              <div class="gif-studio-panel">
                <div class="panel-header">
                  <h3>🎬 GIF Studio</h3>
                </div>

                <!-- Effect Layers Pills -->
                <div class="effect-layers-section">
                  <label class="section-label">Effect Layers</label>
                  
                  <div class="effect-pills-container">
                    @for (layer of getSortedLayers(); track layer.id) {
                      <div class="effect-pill" 
                           [class.active]="selectedLayerId() === layer.id"
                           [class.disabled]="!layer.enabled"
                           [class.editing]="editingLayerId() === layer.id">
                        
                        <div class="pill-header" (click)="selectLayer(layer.id)">
                          <span class="pill-icon">{{ effectNames[layer.type].split(' ')[0] }}</span>
                          <span class="pill-name">{{ effectNames[layer.type].split(' ').slice(1).join(' ') }}</span>
                          <div class="pill-actions">
                            <button class="pill-btn" 
                                    (click)="toggleLayerEnabled(layer.id); $event.stopPropagation()" 
                                    [title]="layer.enabled ? 'Disable' : 'Enable'">
                              {{ layer.enabled ? '👁️' : '🚫' }}
                            </button>
                            <button class="pill-btn" 
                                    (click)="editLayer(layer.id); $event.stopPropagation()" 
                                    title="Edit">
                              ✏️
                            </button>
                            <button class="pill-btn pill-btn-danger" 
                                    (click)="removeEffectLayer(layer.id); $event.stopPropagation()" 
                                    title="Delete">
                              🗑️
                            </button>
                          </div>
                        </div>
                      </div>
                    }

                    @if (effectLayers().length === 0) {
                      <div class="empty-layers">
                        <p>No effect layers yet. Add one below! 👇</p>
                      </div>
                    }
                  </div>

                  <!-- Add Effect Buttons -->
                  <div class="add-effect-section">
                    <label class="section-label">Add Effect</label>
                    <div class="add-effect-buttons">
                      @for (effectType of availableEffects; track effectType) {
                        <button class="btn-add-effect" (click)="addEffectLayer(effectType)">
                          {{ effectNames[effectType] }}
                        </button>
                      }
                    </div>
                  </div>
                </div>

                <!-- Separator -->
                <div class="section-divider"></div>

                <!-- Global GIF Settings -->
                <div class="global-gif-settings">
                  <label class="section-label">⚙️ GIF Animation Settings</label>

                  <!-- Frame Count -->
                  <div class="control-group">
                    <label class="control-label">
                      <span class="control-name">📊 Frame Count</span>
                      <span class="control-value">{{ gifFrameCount() }} frames</span>
                    </label>
                    <input type="range" min="5" max="60" step="5" class="slider" 
                           [ngModel]="gifFrameCount()" 
                           (ngModelChange)="gifFrameCount.set($event); onGifOptionsUpdate()"
                           title="Number of frames in the animation">
                    <div class="control-hint">More frames = smoother animation (but larger file)</div>
                  </div>

                  <!-- Frame Delay (en ms) -->
                  <div class="control-group">
                    <label class="control-label">
                      <span class="control-name">⏱️ Frame Delay</span>
                      <span class="control-value">{{ getFrameDelay() }} ms/frame</span>
                    </label>
                    <input type="range" min="20" max="500" step="10" class="slider" 
                           [ngModel]="getFrameDelay()" 
                           (ngModelChange)="setFrameDelayFromMs($event); onGifOptionsUpdate()"
                           title="Duration of each frame in milliseconds">
                    <div class="control-hint">
                      <span class="fps-display">{{ getFPS() }} FPS</span> • 
                      <span class="duration-display">Total: {{ getTotalDuration() }}s</span>
                    </div>
                  </div>

                  <!-- Animation Info Display -->
                  <div class="animation-info-box">
                    <div class="info-row">
                      <span class="info-label">🎞️ Animation:</span>
                      <span class="info-value">{{ gifFrameCount() }} frames × {{ getFrameDelay() }}ms</span>
                    </div>
                    <div class="info-row">
                      <span class="info-label">⚡ Speed:</span>
                      <span class="info-value">{{ getFPS() }} FPS</span>
                    </div>
                    <div class="info-row">
                      <span class="info-label">⏲️ Duration:</span>
                      <span class="info-value">{{ getTotalDuration() }}s per loop</span>
                    </div>
                  </div>

                  <!-- Loop Count -->
                  <div class="control-group">
                    <label class="control-label">
                      <span class="control-name">🔁 Loop Mode</span>
                    </label>
                    <select class="select-input" [ngModel]="gifLoopCount()" (ngModelChange)="gifLoopCount.set($event)">
                      <option [value]="0">♾️ Loop Forever (Seamless)</option>
                      <option [value]="-1">🔚 Play Once (No Loop)</option>
                      <option [value]="2">↻ Loop 2 times</option>
                      <option [value]="3">↻ Loop 3 times</option>
                      <option [value]="5">↻ Loop 5 times</option>
                      <option [value]="10">↻ Loop 10 times</option>
                    </select>
                    <div class="control-hint">How many times the GIF repeats</div>
                  </div>

                  <button class="btn-primary" (click)="downloadAnimatedGif()" 
                          [disabled]="generatingGif()" 
                          style="width: 100%; margin-top: 12px;">
                    @if (generatingGif()) {
                      <span>🔄 Generating...</span>
                    } @else {
                      <span>✨ Generate GIF</span>
                    }
                  </button>
                </div>
              </div>
              <!-- Fin gif-studio-panel -->

              <!-- Effect Layer Editor (justo debajo del GIF Studio) -->
              @if (editingLayerId()) {
                <div class="effect-editor-panel">
                  @for (layer of effectLayers(); track layer.id) {
                    @if (layer.id === editingLayerId()) {
                      <div class="editor-panel-header">
                        <h4>✏️ {{ effectNames[layer.type] }}</h4>
                        <button class="btn-close-editor" (click)="closeLayerEditor()">✕</button>
                      </div>

                      <div class="editor-panel-body">
                        <!-- Intensity Control (común para todos) -->
                        <div class="control-group">
                          <label class="control-label">
                            <span>Intensity</span>
                            <span class="control-value">{{ (layer.intensity * 100).toFixed(0) }}%</span>
                          </label>
                          <input type="range" min="0" max="1" step="0.1" class="slider" 
                                 [ngModel]="layer.intensity" 
                                 (ngModelChange)="updateLayerIntensity(layer.id, $event)">
                        </div>

                        <!-- Scanline Options -->
                        @if (layer.type === 'scanline') {
                          <div class="control-group">
                            <label class="control-label">
                              <span>Thickness</span>
                              <span class="control-value">{{ layer.options.scanlineThickness }}</span>
                            </label>
                            <input type="range" min="1" max="5" step="1" class="slider" 
                                   [ngModel]="layer.options.scanlineThickness" 
                                   (ngModelChange)="updateLayerOption(layer.id, 'scanlineThickness', $event)">
                          </div>
                          <div class="control-group">
                            <label class="control-label">
                              <span>Spacing</span>
                              <span class="control-value">{{ layer.options.scanlineSpacing }}</span>
                            </label>
                            <input type="range" min="2" max="8" step="1" class="slider" 
                                   [ngModel]="layer.options.scanlineSpacing" 
                                   (ngModelChange)="updateLayerOption(layer.id, 'scanlineSpacing', $event)">
                          </div>
                        }

                      <!-- VHS Options -->
                      @if (layer.type === 'vhs') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Distortion</span>
                            <span class="control-value">{{ layer.options.vhsDistortion }}</span>
                          </label>
                          <input type="range" min="1" max="15" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsDistortion" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsDistortion', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Color Bleed</span>
                            <span class="control-value">{{ layer.options.vhsColorBleed }}</span>
                          </label>
                          <input type="range" min="1" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsColorBleed" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsColorBleed', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Line Thickness</span>
                            <span class="control-value">{{ layer.options.vhsLineThickness }}</span>
                          </label>
                          <input type="range" min="1" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsLineThickness" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsLineThickness', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Tracking Noise</span>
                            <span class="control-value">{{ layer.options.vhsTrackingNoise }}%</span>
                          </label>
                          <input type="range" min="0" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsTrackingNoise" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsTrackingNoise', $event)">
                        </div>
                        <div class="control-group-header">🎨 Color Channel Bleeding</div>
                        <div class="control-group">
                          <label class="control-label">
                            <span style="color: #ff6b6b;">Red Shift</span>
                            <span class="control-value">{{ layer.options.vhsBleedRed }}</span>
                          </label>
                          <input type="range" min="-10" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsBleedRed" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsBleedRed', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span style="color: #6bff6b;">Green Shift</span>
                            <span class="control-value">{{ layer.options.vhsBleedGreen }}</span>
                          </label>
                          <input type="range" min="-10" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsBleedGreen" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsBleedGreen', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span style="color: #6b6bff;">Blue Shift</span>
                            <span class="control-value">{{ layer.options.vhsBleedBlue }}</span>
                          </label>
                          <input type="range" min="-10" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsBleedBlue" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsBleedBlue', $event)">
                        </div>
                      }

                      <!-- Noise Options -->
                      @if (layer.type === 'noise') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Type</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.noiseType" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'noiseType', $event)">
                            <option value="film">🎞️ Film</option>
                            <option value="digital">💾 Digital</option>
                            <option value="grain">🌾 Grain</option>
                          </select>
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Size</span>
                            <span class="control-value">{{ layer.options.noiseSize }}</span>
                          </label>
                          <input type="range" min="1" max="5" step="1" class="slider" 
                                 [ngModel]="layer.options.noiseSize" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'noiseSize', $event)">
                        </div>
                      }

                      <!-- Phosphor Options -->
                      @if (layer.type === 'phosphor') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Decay</span>
                            <span class="control-value">{{ (layer.options.phosphorDecay! * 100).toFixed(0) }}%</span>
                          </label>
                          <input type="range" min="0" max="1" step="0.1" class="slider" 
                                 [ngModel]="layer.options.phosphorDecay" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'phosphorDecay', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Glow</span>
                            <span class="control-value">{{ (layer.options.phosphorGlow! * 100).toFixed(0) }}%</span>
                          </label>
                          <input type="range" min="0" max="1" step="0.1" class="slider" 
                                 [ngModel]="layer.options.phosphorGlow" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'phosphorGlow', $event)">
                        </div>
                      }

                      <!-- RGB Split Options -->
                      @if (layer.type === 'rgb-split') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Direction</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.rgbSplitDirection" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'rgbSplitDirection', $event)">
                            <option value="horizontal">↔️ Horizontal</option>
                            <option value="vertical">↕️ Vertical</option>
                            <option value="diagonal">↗️ Diagonal</option>
                          </select>
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Amount</span>
                            <span class="control-value">{{ layer.options.rgbSplitAmount }}</span>
                          </label>
                          <input type="range" min="1" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.rgbSplitAmount" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'rgbSplitAmount', $event)">
                        </div>
                      }

                      <!-- Motion Sense Options -->
                      @if (layer.type === 'motion-sense') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Direction</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.motionDirection" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'motionDirection', $event)">
                            <option value="horizontal">↔️ Horizontal</option>
                            <option value="vertical">↕️ Vertical</option>
                            <option value="radial">🌀 Radial</option>
                            <option value="zoom">🔍 Zoom</option>
                          </select>
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Speed</span>
                            <span class="control-value">{{ layer.options.motionSpeed }}</span>
                          </label>
                          <input type="range" min="0.5" max="3" step="0.5" class="slider" 
                                 [ngModel]="layer.options.motionSpeed" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'motionSpeed', $event)">
                        </div>
                      }

                      <!-- Particles Options -->
                      @if (layer.type === 'particles') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Count</span>
                            <span class="control-value">{{ layer.options.particleCount }}</span>
                          </label>
                          <input type="range" min="10" max="200" step="10" class="slider" 
                                 [ngModel]="layer.options.particleCount" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'particleCount', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Size</span>
                            <span class="control-value">{{ layer.options.particleSize }}</span>
                          </label>
                          <input type="range" min="1" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.particleSize" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'particleSize', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Speed</span>
                            <span class="control-value">{{ layer.options.particleSpeed }}</span>
                          </label>
                          <input type="range" min="0.5" max="3" step="0.5" class="slider" 
                                 [ngModel]="layer.options.particleSpeed" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'particleSpeed', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Color</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.particleColor" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'particleColor', $event)">
                            <option value="white">⚪ White</option>
                            <option value="rainbow">🌈 Rainbow</option>
                            <option value="warm">🔥 Warm</option>
                            <option value="cool">❄️ Cool</option>
                          </select>
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Shape</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.particleShape" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'particleShape', $event)">
                            <option value="circle">⭕ Circle</option>
                            <option value="star">⭐ Star</option>
                            <option value="square">⬜ Square</option>
                            <option value="sparkle">✨ Sparkle</option>
                            <option value="custom">🎨 Custom</option>
                          </select>
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Emission Mode</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.particleEmissionMode" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'particleEmissionMode', $event)">
                            <option value="float">🎈 Float (Everywhere)</option>
                            <option value="burst">💥 Burst (Explosion)</option>
                            <option value="fountain">⛲ Fountain (From Bottom)</option>
                            <option value="spiral">🌀 Spiral</option>
                            <option value="edges">📐 Edges (From Borders)</option>
                            <option value="rain">🌧️ Rain (From Top)</option>
                            <option value="center">⭕ Center (Pulse)</option>
                          </select>
                        </div>
                        
                        <!-- Custom Particle Editor Button -->
                        @if (layer.options.particleShape === 'custom') {
                          <div class="control-group">
                            <button class="btn-secondary" (click)="openParticleEditor(layer.id)" style="width: 100%;">
                              🎨 Draw Custom Particle
                            </button>
                          </div>
                        }
                      }

                      <!-- Flames Options -->
                      @if (layer.type === 'flames') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Algorithm</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.flameAlgorithm" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'flameAlgorithm', $event)">
                            <option value="classic">📼 Classic</option>
                            <option value="realistic">🔥 Realistic</option>
                            <option value="plasma">⚡ Plasma</option>
                            <option value="dragon">🐉 Dragon</option>
                            <option value="wispy">💨 Wispy</option>
                            <option value="inferno">🌋 Inferno</option>
                          </select>
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Height</span>
                            <span class="control-value">{{ layer.options.flameHeight }}%</span>
                          </label>
                          <input type="range" min="10" max="60" step="5" class="slider" 
                                 [ngModel]="layer.options.flameHeight" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'flameHeight', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Flame Intensity</span>
                            <span class="control-value">{{ (layer.options.flameIntensity! * 100).toFixed(0) }}%</span>
                          </label>
                          <input type="range" min="0" max="1" step="0.1" class="slider" 
                                 [ngModel]="layer.options.flameIntensity" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'flameIntensity', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Turbulence</span>
                            <span class="control-value">{{ layer.options.flameTurbulence }}</span>
                          </label>
                          <input type="range" min="0.5" max="2" step="0.5" class="slider" 
                                 [ngModel]="layer.options.flameTurbulence" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'flameTurbulence', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Color</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.flameColor" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'flameColor', $event)">
                            <option value="red">🔴 Red</option>
                            <option value="blue">🔵 Blue</option>
                            <option value="green">🟢 Green</option>
                            <option value="purple">🟣 Purple</option>
                            <option value="rainbow">🌈 Rainbow</option>
                          </select>
                        </div>
                      }

                      <!-- Layer Order Controls -->
                      <div class="layer-order-controls">
                        <button class="btn-secondary btn-small" 
                                (click)="moveLayerUp(layer.id)"
                                [disabled]="layer.order === 0">
                          ⬆️ Move Up
                        </button>
                        <button class="btn-secondary btn-small" 
                                (click)="moveLayerDown(layer.id)"
                                [disabled]="layer.order === effectLayers().length - 1">
                          ⬇️ Move Down
                        </button>
                      </div>
                    </div>
                  }
                }
              </div>
            }
            </div>
            <!-- Fin gif-studio-container -->

            <!-- Canvas para modo GIF -->
            <div class="canvas-container">
              <div class="canvas-header">
                <h3>GIF Preview</h3>
                @if (processing()) {
                  <span class="processing-badge">Processing...</span>
                }
              </div>
              <div class="gif-preview-viewer" [class.fit-mode]="gifViewMode() === 'fit'" [class.original-mode]="gifViewMode() === 'original'">
                <!-- Indicador de carga para preview GIF -->
                @if (isGeneratingPreview) {
                  <div class="preview-loading-overlay">
                    <div class="preview-loading-spinner">
                      <div class="spinner-ring"></div>
                      <div class="spinner-text">Generating Preview...</div>
                    </div>
                  </div>
                }
                
                <!-- Controles de zoom para GIF Preview -->
                <div class="canvas-controls-overlay">
                  <div class="tv-control-panel">
                    <button class="tv-btn" (click)="gifZoomOut()" [disabled]="gifZoomLevel() <= 25" title="Zoom Out">
                      <span class="tv-btn-icon">➖</span>
                    </button>
                    <span class="tv-display">{{ gifZoomLevel() }}%</span>
                    <button class="tv-btn" (click)="gifZoomIn()" [disabled]="gifZoomLevel() >= 200" title="Zoom In">
                      <span class="tv-btn-icon">➕</span>
                    </button>
                    <button class="tv-btn" (click)="resetGifZoom()" title="Reset Zoom">
                      <span class="tv-btn-text">100%</span>
                    </button>
                    <div class="tv-divider"></div>
                    <button class="tv-btn" 
                            [class.active]="gifViewMode() === 'fit'"
                            (click)="setGifViewMode('fit')" 
                            title="Fit to View">
                      <span class="tv-btn-icon">⬚</span>
                    </button>
                    <button class="tv-btn" 
                            [class.active]="gifViewMode() === 'original'"
                            (click)="setGifViewMode('original')" 
                            title="Original Size">
                      <span class="tv-btn-icon">⊡</span>
                    </button>
                  </div>
                </div>
                
                <div class="gif-preview-scroll-container">
                  <div class="gif-preview-content" [style.width.px]="getGifScaledWidth()" [style.height.px]="getGifScaledHeight()">
                    <canvas #processedCanvas></canvas>
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- Composition Mode Layout (Photoshop style) -->
          @if (compositionMode()) {
            <div class="composition-workspace-layout">
              <!-- Left Toolbar (Photoshop style) -->
              <div class="composition-sidebar-left">
                <app-composition-toolbar
                  (toolChange)="onToolChange($event)"
                  (optionsChange)="onToolOptionsChange($event)">
                </app-composition-toolbar>
              </div>
              
              <!-- Main Canvas Area -->
              <div class="composition-canvas-area">
                <div class="canvas-header">
                  <h3>🎨 Composition Canvas</h3>
                  <div class="canvas-info">
                    {{ compositionService.compositionState().canvasWidth }} × 
                    {{ compositionService.compositionState().canvasHeight }}px
                  </div>
                  
                  <!-- Undo/Redo Controls -->
                  <div class="undo-redo-controls">
                    <button 
                      class="btn-undo-redo" 
                      [disabled]="!historyService.canUndo()"
                      (click)="historyService.undo()"
                      [title]="'Undo: ' + (historyService.getUndoDescription() || 'Nothing to undo') + ' (Ctrl+Z)'">
                      <span class="icon">↶</span>
                      <span class="label">Undo</span>
                    </button>
                    <button 
                      class="btn-undo-redo" 
                      [disabled]="!historyService.canRedo()"
                      (click)="historyService.redo()"
                      [title]="'Redo: ' + (historyService.getRedoDescription() || 'Nothing to redo') + ' (Ctrl+Y)'">
                      <span class="icon">↷</span>
                      <span class="label">Redo</span>
                    </button>
                    <div class="history-info">
                      {{ historyService.getHistorySize().undo }} / {{ historyService.getHistorySize().redo }}
                    </div>
                  </div>
                </div>
                <app-composition-canvas></app-composition-canvas>
              </div>
              
              <!-- Right Sidebar: Layers Panel (Photoshop style) -->
              <div class="composition-sidebar-right">
                <app-composition-layers></app-composition-layers>
                <app-layer-properties></app-layer-properties>
              </div>
            </div>
          }

          <!-- Modo Imagen: Comparador Before/After -->
          @if (!gifStudioMode() && !compositionMode()) {
            <div class="canvas-header">
              <h3>Image Comparison</h3>
              @if (processing()) {
                <span class="processing-badge">Processing...</span>
              }
            </div>
            
            <div class="comparison-viewer" [class.fit-mode]="viewMode() === 'fit'" [class.original-mode]="viewMode() === 'original'">
              <!-- Indicador de carga para preview -->
              @if (isGeneratingPreview) {
                <div class="preview-loading-overlay">
                  <div class="preview-loading-spinner">
                    <div class="spinner-ring"></div>
                    <div class="spinner-text">Optimizing Preview...</div>
                  </div>
                </div>
              }
              
              <!-- Controles internos del canvas (estilo TV analógica) -->
              <div class="canvas-controls-overlay">
                <div class="tv-control-panel">
                  <button class="tv-btn" (click)="zoomOut()" [disabled]="zoomLevel() <= 25" title="Zoom Out">
                    <span class="tv-btn-icon">➖</span>
                  </button>
                  <span class="tv-display">{{ zoomLevel() }}%</span>
                  <button class="tv-btn" (click)="zoomIn()" [disabled]="zoomLevel() >= 200" title="Zoom In">
                    <span class="tv-btn-icon">➕</span>
                  </button>
                  <button class="tv-btn" (click)="resetZoom()" title="Reset Zoom">
                    <span class="tv-btn-text">100%</span>
                  </button>
                  <div class="tv-divider"></div>
                  <button class="tv-btn" 
                          [class.active]="viewMode() === 'fit'"
                          (click)="setViewMode('fit')" 
                          title="Fit to View">
                    <span class="tv-btn-icon">⬚</span>
                  </button>
                  <button class="tv-btn" 
                          [class.active]="viewMode() === 'original'"
                          (click)="setViewMode('original')" 
                          title="Original Size">
                    <span class="tv-btn-icon">⊡</span>
                  </button>
                </div>
              </div>
              <div class="comparison-scroll-container">
                <div class="comparison-container" [style.width.px]="getScaledWidth()" [style.height.px]="getScaledHeight()">
                  <!-- Imagen Original (fondo) -->
                  <div class="comparison-layer original-layer">
                    <canvas #originalCompareCanvas></canvas>
                  </div>
                  
                  <!-- Imagen Dithered (revelable) -->
                  <div class="comparison-layer dithered-layer" [style.clip-path]="getClipPath()">
                    <canvas #processedCanvas></canvas>
                  </div>
                  
                  <!-- Slider de división -->
                  <div class="comparison-slider" 
                       [style.left.%]="sliderPosition()"
                       (mousedown)="startDragging($event)"
                       (touchstart)="startDragging($event)">
                    <div class="slider-line"></div>
                    <div class="slider-handle">
                      <span class="slider-arrow left">◀</span>
                      <span class="slider-arrow right">▶</span>
                    </div>
                  </div>
                  
                  <!-- Labels -->
                  <div class="comparison-label left-label">Original</div>
                  <div class="comparison-label right-label">Dithered</div>
                </div>
              </div>
            </div>
          }
        </div>
        <!-- Fin canvas-area -->
        
      </div>
      <!-- Fin editor-content -->
      </div>
      <!-- Fin editor-section -->
    }
  </div>
</div>

<!-- Palette Creator Modal -->
@if (showPaletteCreator()) {
  <div class="modal-overlay" (click)="togglePaletteCreator()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Create Custom Palette</h2>
        <button class="btn-close" (click)="togglePaletteCreator()"></button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Palette Name</label>
          <input type="text" class="text-input" placeholder="My Custom Palette" [ngModel]="newPaletteName()" (ngModelChange)="newPaletteName.set($event)">
        </div>

        <div class="form-group">
          <label>Colors (min 2)</label>
          <div class="color-list">
            @for (color of paletteColors(); track $index) {
              <div class="color-item">
                <input type="color" class="color-picker" [ngModel]="color" (ngModelChange)="updatePaletteColor($index, $event)">
                <input type="text" class="color-hex" [ngModel]="color" (ngModelChange)="updatePaletteColor($index, $event)">
                @if (paletteColors().length > 2) {
                  <button class="btn-remove" (click)="removeColorFromPalette($index)"></button>
                }
              </div>
            }
          </div>
          <button class="btn-secondary" (click)="addColorToPalette()" style="width: 100%; margin-top: 8px;">+ Add Color</button>
        </div>

        <div class="custom-palettes-list">
          <h3>Saved Custom Palettes</h3>
          @for (palette of customPalettes(); track palette.id) {
            <div class="palette-item">
              <div class="palette-info">
                <span class="palette-name">{{ palette.name }}</span>
                <div class="palette-colors">
                  @for (color of palette.colors; track $index) {
                    <span class="color-dot" [style.backgroundColor]="color"></span>
                  }
                </div>
              </div>
              <button class="btn-remove" (click)="deleteCustomPalette(palette.id)">Delete</button>
            </div>
          }
          @if (customPalettes().length === 0) {
            <p class="empty-state">No custom palettes yet</p>
          }
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="togglePaletteCreator()">Cancel</button>
        <button class="btn-primary" (click)="saveCustomPalette()">Save Palette</button>
      </div>
    </div>
  </div>
}

<!-- Preset Manager Modal -->
@if (showPresetManager()) {
  <div class="modal-overlay" (click)="togglePresetManager()">
    <div class="modal-content preset-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>💾 Preset Manager</h2>
        <button class="btn-close" (click)="togglePresetManager()">✕</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Save Current Settings</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" class="text-input" placeholder="Preset Name" [ngModel]="newPresetName()" (ngModelChange)="newPresetName.set($event)" style="flex: 1;">
            <button class="btn-primary" (click)="saveCurrentAsPreset()">Save</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="presets-list">
          <h3>Saved Presets</h3>
          @for (preset of presets(); track preset.id) {
            <div class="preset-item">
              <div class="preset-info">
                <span class="preset-name">{{ preset.name }}</span>
                <span class="preset-details">{{ preset.algorithm }} • {{ preset.palette }}</span>
              </div>
              <div class="preset-actions">
                <button class="btn-secondary" (click)="loadPreset(preset.id)">Load</button>
                <button class="btn-remove" (click)="deletePreset(preset.id)">✕</button>
              </div>
            </div>
          }
          @if (presets().length === 0) {
            <p class="empty-state">No presets saved yet</p>
          }
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="togglePresetManager()">Close</button>
      </div>
    </div>
  </div>
}

<!-- Sprite Uploader Modal -->
@if (showSpriteUploader()) {
  <app-sprite-uploader 
    (close)="showSpriteUploader.set(false)"
    (spriteUpdated)="onSpriteUpdated($event)">
  </app-sprite-uploader>
}

<!-- GIF Loading Modal -->
@if (generatingGif()) {
  <app-gif-loading
    [title]="'Creating Animated GIF'"
    [message]="gifLoadingMessage()"
    [progress]="gifProgress()"
    [waifuSprite]="waifuSpriteUrl()">
  </app-gif-loading>
}

<!-- Particle Editor Modal -->
@if (showParticleEditor()) {
  <div class="modal-overlay" (click)="closeParticleEditor()">
    <div class="modal-content particle-editor-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>🎨 Custom Particle Editor</h3>
        <button class="btn-close" (click)="closeParticleEditor()">✕</button>
      </div>
      
      <div class="modal-body">
        <div class="particle-editor-container">
          <!-- Canvas para dibujar -->
          <div class="drawing-area">
            <canvas #particleCanvas 
                    width="64" 
                    height="64"
                    (mousedown)="startDrawing($event)"
                    (mousemove)="draw($event)"
                    (mouseup)="stopDrawing()"
                    (mouseleave)="stopDrawing()">
            </canvas>
            <div class="canvas-grid"></div>
          </div>
          
          <!-- Controles de dibujo -->
          <div class="drawing-controls">
            <div class="control-group">
              <label class="control-label">
                <span>Brush Size</span>
                <span class="control-value">{{ particleBrushSize() }}px</span>
              </label>
              <input type="range" min="1" max="8" step="1" class="slider" 
                     [ngModel]="particleBrushSize()" 
                     (ngModelChange)="particleBrushSize.set($event)">
            </div>
            
            <div class="control-group">
              <label class="control-label">
                <span>Brush Color</span>
              </label>
              <div class="color-palette">
                <button class="color-btn" 
                        *ngFor="let color of particleColors" 
                        [style.background]="color"
                        [class.active]="particleBrushColor() === color"
                        (click)="particleBrushColor.set(color)">
                </button>
              </div>
            </div>
            
            <div class="button-group">
              <button class="btn-secondary" (click)="clearParticleCanvas()">
                🗑️ Clear
              </button>
              <button class="btn-secondary" (click)="fillParticleCanvas()">
                🎨 Fill
              </button>
            </div>
            
            <div class="saved-particles-section">
              <h4>Saved Particles</h4>
              <div class="saved-particles-grid">
                @for (sprite of savedParticleSprites(); track sprite.id) {
                  <div class="saved-particle-item" 
                       [class.active]="selectedParticleSpriteId() === sprite.id"
                       (click)="loadParticleSprite(sprite.id)">
                    <img [src]="sprite.data" alt="Particle sprite">
                    <button class="btn-delete-sprite" 
                            (click)="deleteParticleSprite(sprite.id); $event.stopPropagation()">
                      ✕
                    </button>
                  </div>
                }
                @if (savedParticleSprites().length === 0) {
                  <p class="empty-message">No saved particles yet</p>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeParticleEditor()">Cancel</button>
        <button class="btn-primary" (click)="saveParticleSprite()">💾 Save & Use</button>
      </div>
    </div>
  </div>
}

<!-- Achievement Notification -->
<app-achievement-notification 
  [event]="achievementService.unlockedAchievement()">
</app-achievement-notification>

<!-- Achievements Panel -->
@if (showAchievements()) {
  <app-achievements-panel></app-achievements-panel>
}

<!-- Gallery -->
@if (showGallery()) {
  <app-gallery 
    (closed)="showGallery.set(false)"
    (settingsApplied)="onGallerySettingsApplied($event)">
  </app-gallery>
}
