<div class="app-container" [class]="deviceService.getResponsiveClasses().join(' ')">
  <!-- Desktop Header -->
  @if (deviceService.isDesktop()) {
    <header class="header">
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <img [src]="navbarLogoUrl()" alt="Logo" class="navbar-logo">
          <div>
            <h1>{{ i18nService.t('app.title') }}</h1>
            <p class="subtitle">{{ i18nService.t('app.subtitle') }}</p>
          </div>
        </div>
        <!-- Test Achievement Button -->
        <button class="btn-test-achievement" (click)="testAchievementNotification()" title="Test Achievement">
          🏆 Test
        </button>
      </div>
    </header>
  }
  
  <!-- Mobile Header (compact) -->
  @if (deviceService.isMobile()) {
    <header class="header header-mobile">
      <div style="display: flex; align-items: center; justify-content: center; width: 100%;">
        <img [src]="navbarLogoUrl()" alt="Logo" class="navbar-logo-mobile">
        <h1 style="font-size: 1.2rem; margin: 0;">{{ i18nService.t('app.title') }}</h1>
      </div>
    </header>
  }
  
  <!-- Hidden file input (always present) -->
  <input #fileInput type="file" accept="image/*" (change)="onFileSelected($event)" style="display: none;">
  
  <!-- MOBILE INTERFACE -->
  @if (deviceService.isMobile()) {
    <div class="mobile-app-content">
      @if (mobileActiveTab() === 'upload') {
        <app-upload-mobile (fileSelected)="onMobileFileSelected($event)"></app-upload-mobile>
      }
      
      @if (imageLoaded() && mobileActiveTab() === 'canvas') {
        <app-canvas-mobile 
          [imageData]="processedImageData"
          [originalImageData]="originalImageData"
          (download)="downloadImage()">
        </app-canvas-mobile>
        
        <!-- Upload new image FAB -->
        <button class="fab-upload" (click)="triggerFileInput()" title="Upload New Image"></button>
        
        <!-- Controls Bottom Sheet -->
        @if (showMobileControls()) {
          <div class="mobile-controls-overlay" (click)="showMobileControls.set(false)">
            <div class="mobile-controls-sheet" (click)="$event.stopPropagation()">
              <app-controls-mobile
                [options]="{
                  algorithm: selectedAlgorithm(),
                  palette: selectedPalette(),
                  scale: scale(),
                  contrast: contrast(),
                  midtones: midtones(),
                  highlights: highlights(),
                  blur: blur()
                }"
                [algorithms]="algorithms()"
                [palettes]="palettes()"
                (optionsChange)="onMobileControlsChange($event)"
                (reset)="resetControls()"
                (apply)="showMobileControls.set(false)">
              </app-controls-mobile>
            </div>
          </div>
        }
        
        <!-- Floating controls button -->
        <button class="fab-controls" (click)="showMobileControls.set(true)" title="Controls"></button>
      }
      
      @if (mobileActiveTab() === 'composition') {
        <!-- Nivel 0: Canvas (Fullscreen Background) -->
        <div class="composition-workspace">
          <app-composition-canvas></app-composition-canvas>
        </div>
        
        <!-- Nivel 2: Toolbar Flotante (Izquierda, Colapsable) -->
        <div class="composition-tools-strip" [class.collapsed]="toolsCollapsed()">
          <button class="tools-toggle" (click)="toolsCollapsed.set(!toolsCollapsed())">
            {{ toolsCollapsed() ? '❯' : '❮' }}
          </button>
          @if (!toolsCollapsed()) {
            <app-composition-toolbar></app-composition-toolbar>
          }
        </div>
        
        <!-- Nivel 1: Top Bar Compacto (Undo/Redo) -->
        <div class="composition-top-bar">
          <button class="top-btn" [disabled]="!historyService.canUndo()" (click)="historyService.undo()" title="Undo">↶</button>
          <button class="top-btn" [disabled]="!historyService.canRedo()" (click)="historyService.redo()" title="Redo">↷</button>
          <div class="top-divider"></div>
          <button class="top-btn" (click)="showCompositionLayers.set(true)" title="Layers">📚</button>
          <button class="top-btn" (click)="showLayerProps.set(true)" title="Properties">⚙️</button>
        </div>
        
        <!-- Nivel 3: Layers Panel (Bottom Sheet) -->
        @if (showCompositionLayers()) {
          <div class="bottom-sheet-overlay" (click)="showCompositionLayers.set(false)">
            <div class="bottom-sheet" (click)="$event.stopPropagation()">
              <div class="sheet-handle"></div>
              <div class="sheet-header">
                <h3>Layers</h3>
                <button class="sheet-close" (click)="showCompositionLayers.set(false)">✕</button>
              </div>
              <div class="sheet-content">
                <app-composition-layers></app-composition-layers>
              </div>
            </div>
          </div>
        }
        
        <!-- Nivel 3: Properties Panel (Bottom Sheet) -->
        @if (showLayerProps()) {
          <div class="bottom-sheet-overlay" (click)="showLayerProps.set(false)">
            <div class="bottom-sheet" (click)="$event.stopPropagation()">
              <div class="sheet-handle"></div>
              <div class="sheet-header">
                <h3>Layer Properties</h3>
                <button class="sheet-close" (click)="showLayerProps.set(false)">✕</button>
              </div>
              <div class="sheet-content">
                <app-layer-properties></app-layer-properties>
              </div>
            </div>
          </div>
        }
      }
      
      @if (mobileActiveTab() === 'gif') {
        <!-- Hidden composition canvas for rendering -->
        <div style="position: absolute; left: -9999px; top: -9999px; pointer-events: none;">
          <app-composition-canvas></app-composition-canvas>
        </div>
        
        <!-- Nivel 0: GIF Preview Workspace (Fullscreen Background) -->
        <div class="gif-workspace-mobile">
          <div class="gif-preview-mobile">
            @if (originalImage) {
              <!-- Use composition canvas for preview with effects applied -->
              <canvas #gifStudioCanvas 
                      [width]="originalImageData?.width || 800" 
                      [height]="originalImageData?.height || 600"
                      class="gif-canvas-mobile"></canvas>
            } @else {
              <div class="gif-placeholder-mobile">
                <span class="placeholder-icon">🎬</span>
                <p>Upload an image to start</p>
              </div>
            }
          </div>
        </div>
        
        <!-- Download Button (Floating) -->
        <button class="gif-download-btn" 
                [disabled]="effectLayers().length === 0" 
                (click)="downloadGifMobile()" 
                title="Download GIF">
          <span class="download-icon">💾</span>
        </button>
        
        <!-- Effect Layers Panel (Bottom Drawer - Compact) -->
        <div class="gif-studio-mobile-panel" [class.collapsed]="gifPanelCollapsed()">
          <button class="panel-toggle" (click)="toggleGifPanel()">
            <span class="toggle-icon">{{ gifPanelCollapsed() ? '▲' : '▼' }}</span>
            <span class="toggle-text">Effects ({{ effectLayers().length }})</span>
          </button>
          
          <div class="mobile-panel-content">
            <!-- Effect Pills (Compact) -->
            <div class="effect-pills-mobile">
              @for (layer of getSortedLayers(); track layer.id) {
                <div class="effect-pill-mobile" 
                     [class.active]="editingLayerId() === layer.id"
                     [class.disabled]="!layer.enabled"
                     (click)="editLayer(layer.id)">
                  <span class="pill-icon">{{ effectNames[layer.type].split(' ')[0] }}</span>
                  <span class="pill-name">{{ effectNames[layer.type].split(' ').slice(1).join(' ') }}</span>
                  <div class="pill-actions">
                    <button class="pill-btn-mini" 
                            (click)="toggleLayerEnabled(layer.id); $event.stopPropagation()">
                      {{ layer.enabled ? '👁' : '⚫' }}
                    </button>
                    <button class="pill-btn-mini pill-btn-danger" 
                            (click)="removeEffectLayer(layer.id); $event.stopPropagation()">
                      ×
                    </button>
                  </div>
                </div>
              }

              @if (effectLayers().length === 0) {
                <div class="empty-layers-mobile">
                  <p>No effects added</p>
                </div>
              }
            </div>

            <!-- Add Effect Dropdown (Compact) -->
            <select class="select-add-effect-mobile" (change)="addEffectFromSelect($event)" [value]="''">
              <option value="" disabled selected>+ Add Effect</option>
              @for (effectType of availableEffects; track effectType) {
                <option [value]="effectType">{{ effectNames[effectType] }}</option>
              }
            </select>

            <!-- Effect Editor (Inline when editing) -->
            @if (editingLayerId()) {
              @for (layer of effectLayers(); track layer.id) {
                @if (layer.id === editingLayerId()) {
                  <div class="effect-editor-mobile">
                    <div class="editor-header-mobile">
                      <h4>{{ effectNames[layer.type] }}</h4>
                      <button class="editor-close-btn" (click)="closeLayerEditor()">×</button>
                    </div>
                    
                    <div class="editor-controls-mobile">
                      <!-- Intensity -->
                      <div class="control-group-mobile">
                        <div class="control-label-row">
                          <label>Intensity</label>
                          <span class="control-value">{{ (layer.intensity * 100).toFixed(0) }}%</span>
                        </div>
                        <input type="range" 
                               [value]="layer.intensity * 100" 
                               (input)="updateLayerIntensityMobile(layer.id, $event)" 
                               min="0" max="100" step="1">
                      </div>

                      <!-- Effect-specific controls -->
                      @switch (layer.type) {
                        @case ('scanline') {
                          <div class="control-group-mobile">
                            <div class="control-label-row">
                              <label>Thickness</label>
                              <span class="control-value">{{ layer.options.scanlineThickness || 2 }}</span>
                            </div>
                            <input type="range" 
                                   [value]="layer.options.scanlineThickness || 2" 
                                   (input)="updateLayerOptionMobile(layer.id, 'scanlineThickness', $event)" 
                                   min="1" max="10" step="0.5">
                          </div>
                          <div class="control-group-mobile">
                            <div class="control-label-row">
                              <label>Spacing</label>
                              <span class="control-value">{{ layer.options.scanlineSpacing || 4 }}</span>
                            </div>
                            <input type="range" 
                                   [value]="layer.options.scanlineSpacing || 4" 
                                   (input)="updateLayerOptionMobile(layer.id, 'scanlineSpacing', $event)" 
                                   min="2" max="20" step="1">
                          </div>
                        }
                        @case ('vhs') {
                          <div class="control-group-mobile">
                            <div class="control-label-row">
                              <label>Distortion</label>
                              <span class="control-value">{{ layer.options.vhsDistortion || 5 }}</span>
                            </div>
                            <input type="range" 
                                   [value]="layer.options.vhsDistortion || 5" 
                                   (input)="updateLayerOptionMobile(layer.id, 'vhsDistortion', $event)" 
                                   min="0" max="20" step="1">
                          </div>
                        }
                        @case ('noise') {
                          <div class="control-group-mobile">
                            <div class="control-label-row">
                              <label>Size</label>
                              <span class="control-value">{{ layer.options.noiseSize || 1 }}</span>
                            </div>
                            <input type="range" 
                                   [value]="layer.options.noiseSize || 1" 
                                   (input)="updateLayerOptionMobile(layer.id, 'noiseSize', $event)" 
                                   min="1" max="10" step="1">
                          </div>
                        }
                        @case ('rgb-split') {
                          <div class="control-group-mobile">
                            <div class="control-label-row">
                              <label>Amount</label>
                              <span class="control-value">{{ layer.options.rgbSplitAmount || 5 }}px</span>
                            </div>
                            <input type="range" 
                                   [value]="layer.options.rgbSplitAmount || 5" 
                                   (input)="updateLayerOptionMobile(layer.id, 'rgbSplitAmount', $event)" 
                                   min="0" max="20" step="1">
                          </div>
                        }
                      }
                    </div>
                  </div>
                }
              }
            }
          </div>
        </div>
      }
      
      @if (mobileActiveTab() === 'gallery') {
        <!-- Gallery Mobile View -->
        <div class="gallery-mobile-wrapper">
          <!-- Search Bar (Top) -->
          <div class="gallery-search-bar">
            <input type="text" 
                   class="search-input-mobile" 
                   placeholder="🔍 Search gallery..."
                   [(ngModel)]="gallerySearchQuery"
                   (input)="onGallerySearch()">
          </div>
          
          <!-- Gallery Grid -->
          <div class="gallery-grid-mobile">
            @if (galleryService.gallery().length === 0) {
              <div class="gallery-empty-mobile">
                <span class="empty-icon">🖼️</span>
                <p>No saved images</p>
                <p class="empty-hint">Save your work to see it here</p>
              </div>
            } @else {
              @for (item of filteredGalleryItems(); track item.id) {
                <div class="gallery-item-mobile" (click)="openGalleryItemMobile(item)">
                  <img [src]="item.thumbnail" [alt]="item.name" class="gallery-thumb-mobile">
                  <div class="gallery-item-overlay">
                    <span class="item-name">{{ item.name }}</span>
                  </div>
                </div>
              }
            }
          </div>
        </div>
        
        <!-- Gallery Item Preview Modal -->
        @if (selectedGalleryItem()) {
          <div class="gallery-modal-overlay" (click)="closeGalleryItemMobile()">
            <div class="gallery-modal-content" (click)="$event.stopPropagation()">
              <button class="modal-close-btn" (click)="closeGalleryItemMobile()">×</button>
              <img [src]="selectedGalleryItem()!.fullImage" 
                   [alt]="selectedGalleryItem()!.name" 
                   class="gallery-modal-image">
              <div class="gallery-modal-actions">
                <button class="modal-action-btn" (click)="loadGalleryItemToCanvas(selectedGalleryItem()!)">
                  <span class="action-icon">📤</span>
                  <span>Load to Canvas</span>
                </button>
                <button class="modal-action-btn modal-action-danger" (click)="deleteGalleryItemMobile(selectedGalleryItem()!)">
                  <span class="action-icon">🗑️</span>
                  <span>Delete</span>
                </button>
              </div>
              <div class="gallery-modal-info">
                <p><strong>{{ selectedGalleryItem()!.name }}</strong></p>
                <p class="info-detail">{{ formatGalleryDate(selectedGalleryItem()!.createdAt) }}</p>
                @if (selectedGalleryItem()!.tags && selectedGalleryItem()!.tags!.length > 0) {
                  <div class="gallery-tags-mobile">
                    @for (tag of selectedGalleryItem()!.tags; track tag) {
                      <span class="tag-badge-mobile">{{ tag }}</span>
                    }
                  </div>
                }
              </div>
            </div>
          </div>
        }
      }
      
      @if (mobileActiveTab() === 'settings') {
        <div style="padding: 2rem; text-align: center; color: var(--theme-text);">
          <h2>Settings</h2>
          <p>Mobile Settings coming soon...</p>
        </div>
      }
      
      <app-navigation-mobile 
        [activeTab]="mobileActiveTab()"
        (tabChange)="mobileActiveTab.set($event)">
      </app-navigation-mobile>
    </div>
  }
  
  <!-- DESKTOP INTERFACE -->
  @if (deviceService.isDesktop()) {
    <!-- Show Waifu Button (cuando est� oculta) -->
    @if (waifuPositionService.position() === 'hidden') {
      <button class="show-waifu-btn" (click)="waifuPositionService.showWaifu()" [title]="i18nService.t('button.showWaifu')">
      </button>
    }

    <div class="main-content">
      @if (!imageLoaded()) {
        <div class="upload-section">
          <div class="upload-area" (click)="triggerFileInput()">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <h2>{{ i18nService.t('upload.title') }}</h2>
            <p>{{ i18nService.t('upload.dragDrop') }}</p>
            <p class="file-info">{{ i18nService.t('upload.formats') }}</p>
          </div>
        </div>
      }

      @if (imageLoaded()) {
        <div class="editor-section">
        <!-- CRT Waifu Monitor (draggable floating mode) -->
        <app-crt-waifu 
          [state]="waifuState()"
          [spriteSheet]="waifuSpriteUrl()"
          [framesPerRow]="3"
          [totalFrames]="6"
          (click)="onWaifuClick()"
          (spriteUploaderRequested)="showSpriteUploader.set(true)">
        </app-crt-waifu>
        
        <div class="editor-content">
          <div class="controls-panel">
            <div class="panel-header">
              <h3>{{ i18nService.t('controls.title') }}</h3>
              <button class="btn-secondary" (click)="resetControls()">{{ i18nService.t('controls.reset') }}</button>
            </div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>{{ i18nService.t('controls.style') }}</span>
            </label>
            <select class="select-input" [ngModel]="selectedAlgorithm()" (ngModelChange)="selectedAlgorithm.set($event); onAlgorithmChange()">
              @for (category of categoryKeys; track category) {
                <optgroup [label]="category">
                  @for (algo of algorithmsByCategory[category]; track algo.id) {
                    <option [value]="algo.id">{{ algo.name }}</option>
                  }
                </optgroup>
              }
            </select>
          </div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>{{ i18nService.t('dither.palette') }}</span>
            </label>
            <div style="display: flex; gap: 8px;">
              <select class="select-input" style="flex: 1;" [ngModel]="selectedPalette()" (ngModelChange)="selectedPalette.set($event); onPaletteChange()">
                @for (palette of palettes(); track palette.id) {
                  <option [value]="palette.id">{{ palette.name }}</option>
                }
              </select>
              <button class="btn-icon" (click)="togglePaletteCreator()" [title]="i18nService.t('controls.createPalette')">+</button>
            </div>
            <!-- Palette Color Preview -->
            <div class="palette-preview">
              @for (color of getSelectedPaletteColors(); track $index) {
                <div class="palette-preview-color" [style.backgroundColor]="color" [title]="color"></div>
              }
            </div>
          </div>

          <div class="divider"></div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>{{ i18nService.t('dither.scale') }}</span>
              <span class="control-value">{{ scale() }}</span>
            </label>
            <input type="range" min="1" max="5" step="0.1" class="slider" [ngModel]="scale()" (ngModelChange)="scale.set($event); onControlChange()">
          </div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>{{ i18nService.t('dither.contrast') }}</span>
              <span class="control-value">{{ contrast() }}</span>
            </label>
            <input type="range" min="0" max="100" step="1" class="slider" [ngModel]="contrast()" (ngModelChange)="contrast.set($event); onControlChange()">
          </div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>{{ i18nService.t('dither.midtones') }}</span>
              <span class="control-value">{{ midtones() }}</span>
            </label>
            <input type="range" min="0" max="100" step="1" class="slider" [ngModel]="midtones()" (ngModelChange)="midtones.set($event); onControlChange()">
          </div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>{{ i18nService.t('dither.highlights') }}</span>
              <span class="control-value">{{ highlights() }}</span>
            </label>
            <input type="range" min="0" max="100" step="1" class="slider" [ngModel]="highlights()" (ngModelChange)="highlights.set($event); onControlChange()">
          </div>

          <div class="control-group">
            <label class="control-label">
              <span class="label-icon"></span>
              <span>{{ i18nService.t('dither.blur') }}</span>
              <span class="control-value">{{ blur() }}</span>
            </label>
            <input type="range" min="0" max="5" step="1" class="slider" [ngModel]="blur()" (ngModelChange)="blur.set($event); onControlChange()">
          </div>

          <div class="divider"></div>

          <div class="action-buttons">
            <button class="btn-secondary" (click)="togglePresetManager()" style="width: 100%;">
              💾 {{ i18nService.t('button.presets') }}
            </button>
            <button class="btn-secondary" (click)="showSpriteUploader.set(true)" style="width: 100%;">
              🎨 {{ i18nService.t('button.customWaifu') }}
            </button>
            
            <div class="divider"></div>
            
            <!-- Achievement & Gallery Buttons -->
            <div class="button-group" style="width: 100%;">
              <button class="btn-secondary btn-group-left" (click)="toggleAchievements()" [title]="i18nService.t('achievement.title')">
                <span>🏆 {{ i18nService.t('button.level') }} {{ achievementService.userProgress().level }}</span>
              </button>
              <button class="btn-secondary btn-group-right" (click)="toggleGallery()" [title]="i18nService.t('gallery.title')">
                <span>🖼️ {{ i18nService.t('button.gallery') }} ({{ galleryService.gallery().length }})</span>
              </button>
            </div>
            
            <button class="btn-secondary" (click)="toggleSettings()" [title]="i18nService.t('button.settings')" style="width: 100%;">
              ⚙️ {{ i18nService.t('button.settings') }}
            </button>
            
            <button class="btn-secondary" (click)="saveToGallery()" [disabled]="canSaveToGallery()" style="width: 100%;">
              💾 {{ i18nService.t('button.saveGallery') }}
            </button>
            
            <div class="divider"></div>
            
            <div class="button-group" style="width: 100%;">
              <button class="btn-secondary btn-group-left" (click)="downloadImage()" [disabled]="processing()">
                @if (processing()) {
                  <span>⏳</span>
                } @else {
                  <span>💾 {{ i18nService.t('button.download') }}</span>
                }
              </button>
              <button class="btn-secondary btn-group-right" 
                      [class.active]="gifStudioMode()"
                      (click)="toggleGifStudioMode()" 
                      [disabled]="processing()">
                @if (gifStudioMode()) {
                  <span>✨ {{ i18nService.t('button.gifMode') }}</span>
                } @else {
                  <span>🎬 {{ i18nService.t('button.gifStudio') }}</span>
                }
              </button>
            </div>
            
            <!-- Composition Mode Button -->
            <button class="btn-secondary" 
                    [class.active]="compositionMode()"
                    (click)="toggleCompositionMode()" 
                    [disabled]="processing()"
                    style="width: 100%;">
              @if (compositionMode()) {
                <span>✨ Layers Active</span>
              } @else {
                <span>🎨 Composition Layers</span>
              }
            </button>
            
            <button class="btn-secondary" (click)="triggerFileInput()">
              🖼️ New Image
            </button>
          </div>
        </div>
        <!-- Fin controls-panel -->

        <div class="canvas-area" [class.gif-mode]="gifStudioMode()" [class.composition-mode]="compositionMode()">
          
          <!-- Mode Navigation Bar -->
          <div class="mode-navigation-bar">
            <button 
              class="mode-btn" 
              [class.active]="!gifStudioMode() && !compositionMode()"
              (click)="exitAllModes()"
              title="Image Preview & Dithering">
              <span class="icon">🖼️</span>
              <span class="label">Preview</span>
            </button>
            
            <button 
              class="mode-btn" 
              [class.active]="compositionMode()"
              (click)="toggleCompositionMode()"
              title="Layer Composition Mode">
              <span class="icon">🎨</span>
              <span class="label">Composition</span>
            </button>
            
            <button 
              class="mode-btn" 
              [class.active]="gifStudioMode()"
              (click)="toggleGifStudioMode()"
              title="GIF Animation Studio">
              <span class="icon">🎬</span>
              <span class="label">GIF Studio</span>
            </button>
          </div>
          
          <!-- GIF Studio Panel + Effect Editor (side by side) -->
          @if (gifStudioMode()) {
            <div class="gif-studio-container">
              <!-- GIF Studio Options -->
              <div class="gif-studio-panel">
                <div class="panel-header">
                  <h3>🎬 GIF Studio</h3>
                </div>

                <!-- Effect Layers Pills -->
                <div class="effect-layers-section">
                  <label class="section-label">Effect Layers</label>
                  
                  <div class="effect-pills-container">
                    @for (layer of getSortedLayers(); track layer.id) {
                      <div class="effect-pill" 
                           [class.active]="selectedLayerId() === layer.id"
                           [class.disabled]="!layer.enabled"
                           [class.editing]="editingLayerId() === layer.id">
                        
                        <div class="pill-header" (click)="selectLayer(layer.id)">
                          <span class="pill-icon">{{ effectNames[layer.type].split(' ')[0] }}</span>
                          <span class="pill-name">{{ effectNames[layer.type].split(' ').slice(1).join(' ') }}</span>
                          <div class="pill-actions">
                            <button class="pill-btn" 
                                    (click)="toggleLayerEnabled(layer.id); $event.stopPropagation()" 
                                    [title]="layer.enabled ? 'Disable' : 'Enable'">
                              {{ layer.enabled ? '👁️' : '🚫' }}
                            </button>
                            <button class="pill-btn" 
                                    (click)="editLayer(layer.id); $event.stopPropagation()" 
                                    title="Edit">
                              ✏️
                            </button>
                            <button class="pill-btn pill-btn-danger" 
                                    (click)="removeEffectLayer(layer.id); $event.stopPropagation()" 
                                    title="Delete">
                              🗑️
                            </button>
                          </div>
                        </div>
                      </div>
                    }

                    @if (effectLayers().length === 0) {
                      <div class="empty-layers">
                        <p>No effect layers yet. Add one below! 🎨</p>
                      </div>
                    }
                  </div>

                  <!-- Add Effect Dropdown -->
                  <div class="add-effect-section">
                    <label class="section-label">Add Effect</label>
                    <select class="select-add-effect" (change)="addEffectFromSelect($event)" [value]="''">
                      <option value="" disabled selected>Select an effect to add...</option>
                      @for (effectType of availableEffects; track effectType) {
                        <option [value]="effectType">{{ effectNames[effectType] }}</option>
                      }
                    </select>
                  </div>
                </div>

                <!-- Separator -->
                <div class="section-divider"></div>

                <!-- Effect Layer Editor (reemplaza GIF Settings) -->
                @if (editingLayerId()) {
                  <div class="effect-editor-inline">
                  @for (layer of effectLayers(); track layer.id) {
                    @if (layer.id === editingLayerId()) {
                      <!-- Vintage Hardware Rack Header -->
                      <div class="vintage-rack-header">
                        <div class="rack-screws">
                          <div class="screw"></div>
                          <div class="screw"></div>
                        </div>
                        <div class="rack-title-bar">
                          <span class="rack-led"></span>
                          <h4 class="rack-title">{{ effectNames[layer.type] }}</h4>
                          <button class="rack-mode-toggle" 
                                  (click)="toggleEffectEditorMode()"
                                  [title]="effectEditorMode() === 'normal' ? 'Switch to Advanced Mode' : 'Switch to Normal Mode'">
                            {{ effectEditorMode() === 'normal' ? '⚙️' : '🛠️' }}
                          </button>
                          <button class="rack-close-btn" (click)="closeLayerEditor()">✕</button>
                        </div>
                        <div class="rack-screws">
                          <div class="screw"></div>
                          <div class="screw"></div>
                        </div>
                      </div>

                      <!-- Normal Mode: Sliders -->
                      @if (effectEditorMode() === 'normal') {
                        <div class="editor-panel-body">
                        <!-- Intensity Control (com�n para todos) -->
                        <div class="control-group">
                          <label class="control-label">
                            <span>Intensity</span>
                            <span class="control-value">{{ (layer.intensity * 100).toFixed(0) }}%</span>
                          </label>
                          <input type="range" min="0" max="1" step="0.1" class="slider" 
                                 [ngModel]="layer.intensity" 
                                 (ngModelChange)="updateLayerIntensity(layer.id, $event)">
                        </div>

                        <!-- Scanline Options -->
                        @if (layer.type === 'scanline') {
                          <div class="control-group">
                            <label class="control-label">
                              <span>Thickness</span>
                              <span class="control-value">{{ layer.options.scanlineThickness }}</span>
                            </label>
                            <input type="range" min="1" max="5" step="1" class="slider" 
                                   [ngModel]="layer.options.scanlineThickness" 
                                   (ngModelChange)="updateLayerOption(layer.id, 'scanlineThickness', $event)">
                          </div>
                          <div class="control-group">
                            <label class="control-label">
                              <span>Spacing</span>
                              <span class="control-value">{{ layer.options.scanlineSpacing }}</span>
                            </label>
                            <input type="range" min="2" max="8" step="1" class="slider" 
                                   [ngModel]="layer.options.scanlineSpacing" 
                                   (ngModelChange)="updateLayerOption(layer.id, 'scanlineSpacing', $event)">
                          </div>
                        }

                      <!-- VHS Options -->
                      @if (layer.type === 'vhs') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Distortion</span>
                            <span class="control-value">{{ layer.options.vhsDistortion }}</span>
                          </label>
                          <input type="range" min="1" max="15" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsDistortion" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsDistortion', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Color Bleed</span>
                            <span class="control-value">{{ layer.options.vhsColorBleed }}</span>
                          </label>
                          <input type="range" min="1" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsColorBleed" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsColorBleed', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Line Thickness</span>
                            <span class="control-value">{{ layer.options.vhsLineThickness }}</span>
                          </label>
                          <input type="range" min="1" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsLineThickness" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsLineThickness', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Tracking Noise</span>
                            <span class="control-value">{{ layer.options.vhsTrackingNoise }}%</span>
                          </label>
                          <input type="range" min="0" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsTrackingNoise" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsTrackingNoise', $event)">
                        </div>
                        <div class="control-group-header"> Color Channel Bleeding</div>
                        <div class="control-group">
                          <label class="control-label">
                            <span style="color: #ff6b6b;">Red Shift</span>
                            <span class="control-value">{{ layer.options.vhsBleedRed }}</span>
                          </label>
                          <input type="range" min="-10" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsBleedRed" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsBleedRed', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span style="color: #6bff6b;">Green Shift</span>
                            <span class="control-value">{{ layer.options.vhsBleedGreen }}</span>
                          </label>
                          <input type="range" min="-10" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsBleedGreen" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsBleedGreen', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span style="color: #6b6bff;">Blue Shift</span>
                            <span class="control-value">{{ layer.options.vhsBleedBlue }}</span>
                          </label>
                          <input type="range" min="-10" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.vhsBleedBlue" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'vhsBleedBlue', $event)">
                        </div>
                      }

                      <!-- Noise Options -->
                      @if (layer.type === 'noise') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Type</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.noiseType" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'noiseType', $event)">
                            <option value="film"> Film</option>
                            <option value="digital"> Digital</option>
                            <option value="grain"> Grain</option>
                          </select>
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Size</span>
                            <span class="control-value">{{ layer.options.noiseSize }}</span>
                          </label>
                          <input type="range" min="1" max="5" step="1" class="slider" 
                                 [ngModel]="layer.options.noiseSize" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'noiseSize', $event)">
                        </div>
                      }

                      <!-- Phosphor Options -->
                      @if (layer.type === 'phosphor') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Decay</span>
                            <span class="control-value">{{ (layer.options.phosphorDecay! * 100).toFixed(0) }}%</span>
                          </label>
                          <input type="range" min="0" max="1" step="0.1" class="slider" 
                                 [ngModel]="layer.options.phosphorDecay" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'phosphorDecay', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Glow</span>
                            <span class="control-value">{{ (layer.options.phosphorGlow! * 100).toFixed(0) }}%</span>
                          </label>
                          <input type="range" min="0" max="1" step="0.1" class="slider" 
                                 [ngModel]="layer.options.phosphorGlow" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'phosphorGlow', $event)">
                        </div>
                      }

                      <!-- RGB Split Options -->
                      @if (layer.type === 'rgb-split') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Direction</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.rgbSplitDirection" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'rgbSplitDirection', $event)">
                            <option value="horizontal"> Horizontal</option>
                            <option value="vertical"> Vertical</option>
                            <option value="diagonal"> Diagonal</option>
                          </select>
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Amount</span>
                            <span class="control-value">{{ layer.options.rgbSplitAmount }}</span>
                          </label>
                          <input type="range" min="1" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.rgbSplitAmount" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'rgbSplitAmount', $event)">
                        </div>
                      }

                      <!-- Motion Sense Options -->
                      @if (layer.type === 'motion-sense') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Direction</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.motionDirection" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'motionDirection', $event)">
                            <option value="horizontal"> Horizontal</option>
                            <option value="vertical"> Vertical</option>
                            <option value="radial"> Radial</option>
                            <option value="zoom"> Zoom</option>
                          </select>
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Speed</span>
                            <span class="control-value">{{ layer.options.motionSpeed }}</span>
                          </label>
                          <input type="range" min="0.5" max="3" step="0.5" class="slider" 
                                 [ngModel]="layer.options.motionSpeed" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'motionSpeed', $event)">
                        </div>
                      }

                      <!-- Particles Options -->
                      @if (layer.type === 'particles') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Count</span>
                            <span class="control-value">{{ layer.options.particleCount }}</span>
                          </label>
                          <input type="range" min="10" max="200" step="10" class="slider" 
                                 [ngModel]="layer.options.particleCount" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'particleCount', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Size</span>
                            <span class="control-value">{{ layer.options.particleSize }}</span>
                          </label>
                          <input type="range" min="1" max="10" step="1" class="slider" 
                                 [ngModel]="layer.options.particleSize" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'particleSize', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Speed</span>
                            <span class="control-value">{{ layer.options.particleSpeed }}</span>
                          </label>
                          <input type="range" min="0.5" max="3" step="0.5" class="slider" 
                                 [ngModel]="layer.options.particleSpeed" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'particleSpeed', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Color</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.particleColor" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'particleColor', $event)">
                            <option value="white"> White</option>
                            <option value="rainbow"> Rainbow</option>
                            <option value="warm"> Warm</option>
                            <option value="cool"> Cool</option>
                          </select>
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Shape</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.particleShape" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'particleShape', $event)">
                            <option value="circle"> Circle</option>
                            <option value="star"> Star</option>
                            <option value="square"> Square</option>
                            <option value="sparkle"> Sparkle</option>
                            <option value="custom"> Custom</option>
                          </select>
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Emission Mode</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.particleEmissionMode" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'particleEmissionMode', $event)">
                            <option value="float"> Float (Everywhere)</option>
                            <option value="burst"> Burst (Explosion)</option>
                            <option value="fountain"> Fountain (From Bottom)</option>
                            <option value="spiral"> Spiral</option>
                            <option value="edges"> Edges (From Borders)</option>
                            <option value="rain"> Rain (From Top)</option>
                            <option value="center"> Center (Pulse)</option>
                          </select>
                        </div>
                        
                        <!-- Custom Particle Editor Button -->
                        @if (layer.options.particleShape === 'custom') {
                          <div class="control-group">
                            <button class="btn-secondary" (click)="openParticleEditor(layer.id)" style="width: 100%;">
                               Draw Custom Particle
                            </button>
                          </div>
                        }
                      }

                      <!-- Flames Options -->
                      @if (layer.type === 'flames') {
                        <div class="control-group">
                          <label class="control-label">
                            <span>Algorithm</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.flameAlgorithm" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'flameAlgorithm', $event)">
                            <option value="classic"> Classic</option>
                            <option value="realistic"> Realistic</option>
                            <option value="plasma"> Plasma</option>
                            <option value="dragon"> Dragon</option>
                            <option value="wispy"> Wispy</option>
                            <option value="inferno"> Inferno</option>
                          </select>
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Height</span>
                            <span class="control-value">{{ layer.options.flameHeight }}%</span>
                          </label>
                          <input type="range" min="10" max="60" step="5" class="slider" 
                                 [ngModel]="layer.options.flameHeight" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'flameHeight', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Flame Intensity</span>
                            <span class="control-value">{{ (layer.options.flameIntensity! * 100).toFixed(0) }}%</span>
                          </label>
                          <input type="range" min="0" max="1" step="0.1" class="slider" 
                                 [ngModel]="layer.options.flameIntensity" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'flameIntensity', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Turbulence</span>
                            <span class="control-value">{{ layer.options.flameTurbulence }}</span>
                          </label>
                          <input type="range" min="0.5" max="2" step="0.5" class="slider" 
                                 [ngModel]="layer.options.flameTurbulence" 
                                 (ngModelChange)="updateLayerOption(layer.id, 'flameTurbulence', $event)">
                        </div>
                        <div class="control-group">
                          <label class="control-label">
                            <span>Color</span>
                          </label>
                          <select class="select-input" 
                                  [ngModel]="layer.options.flameColor" 
                                  (ngModelChange)="updateLayerOption(layer.id, 'flameColor', $event)">
                            <option value="red"> Red</option>
                            <option value="blue"> Blue</option>
                            <option value="green"> Green</option>
                            <option value="purple"> Purple</option>
                            <option value="rainbow"> Rainbow</option>
                          </select>
                        </div>
                      }

                      <!-- Layer Order Controls -->
                      <div class="layer-order-controls">
                        <button class="btn-secondary btn-small" 
                                (click)="moveLayerUp(layer.id)"
                                [disabled]="layer.order === 0">
                           Move Up
                        </button>
                        <button class="btn-secondary btn-small" 
                                (click)="moveLayerDown(layer.id)"
                                [disabled]="layer.order === effectLayers().length - 1">
                           Move Down
                        </button>
                      </div>
                        </div>
                      }

                      <!-- Advanced Mode: Vintage Knobs -->
                      @if (effectEditorMode() === 'advanced') {
                        <div class="vintage-rack-body">
                          <!-- Intensity Knob (com�n para todos) -->
                          <div class="knobs-row">
                            <app-vintage-knob
                              [label]="'Intensity'"
                              [value]="layer.intensity"
                              [min]="0"
                              [max]="1"
                              [step]="0.1"
                              (valueChange)="updateLayerIntensity(layer.id, $event)">
                            </app-vintage-knob>

                            <!-- Scanline Advanced -->
                            @if (layer.type === 'scanline') {
                              <app-vintage-knob
                                [label]="'Thickness'"
                                [value]="layer.options.scanlineThickness!"
                                [min]="1"
                                [max]="5"
                                [step]="1"
                                (valueChange)="updateLayerOption(layer.id, 'scanlineThickness', $event)">
                              </app-vintage-knob>
                              <app-vintage-knob
                                [label]="'Spacing'"
                                [value]="layer.options.scanlineSpacing!"
                                [min]="2"
                                [max]="8"
                                [step]="1"
                                (valueChange)="updateLayerOption(layer.id, 'scanlineSpacing', $event)">
                              </app-vintage-knob>
                            }

                            <!-- VHS Advanced -->
                            @if (layer.type === 'vhs') {
                              <app-vintage-knob
                                [label]="'Distortion'"
                                [value]="layer.options.vhsDistortion!"
                                [min]="1"
                                [max]="15"
                                [step]="1"
                                (valueChange)="updateLayerOption(layer.id, 'vhsDistortion', $event)">
                              </app-vintage-knob>
                              <app-vintage-knob
                                [label]="'Color Bleed'"
                                [value]="layer.options.vhsColorBleed!"
                                [min]="1"
                                [max]="10"
                                [step]="1"
                                (valueChange)="updateLayerOption(layer.id, 'vhsColorBleed', $event)">
                              </app-vintage-knob>
                              <app-vintage-knob
                                [label]="'Tracking'"
                                [value]="layer.options.vhsTrackingNoise!"
                                [min]="0"
                                [max]="10"
                                [step]="1"
                                (valueChange)="updateLayerOption(layer.id, 'vhsTrackingNoise', $event)">
                              </app-vintage-knob>
                            }

                            <!-- Noise Advanced -->
                            @if (layer.type === 'noise') {
                              <app-vintage-knob
                                [label]="'Noise Size'"
                                [value]="layer.options.noiseSize!"
                                [min]="1"
                                [max]="5"
                                [step]="1"
                                (valueChange)="updateLayerOption(layer.id, 'noiseSize', $event)">
                              </app-vintage-knob>
                            }

                            <!-- Phosphor Advanced -->
                            @if (layer.type === 'phosphor') {
                              <app-vintage-knob
                                [label]="'Decay'"
                                [value]="layer.options.phosphorDecay!"
                                [min]="0"
                                [max]="1"
                                [step]="0.1"
                                (valueChange)="updateLayerOption(layer.id, 'phosphorDecay', $event)">
                              </app-vintage-knob>
                              <app-vintage-knob
                                [label]="'Glow'"
                                [value]="layer.options.phosphorGlow!"
                                [min]="0"
                                [max]="1"
                                [step]="0.1"
                                (valueChange)="updateLayerOption(layer.id, 'phosphorGlow', $event)">
                              </app-vintage-knob>
                            }

                            <!-- RGB Split Advanced -->
                            @if (layer.type === 'rgb-split') {
                              <app-vintage-knob
                                [label]="'Amount'"
                                [value]="layer.options.rgbSplitAmount!"
                                [min]="1"
                                [max]="10"
                                [step]="1"
                                (valueChange)="updateLayerOption(layer.id, 'rgbSplitAmount', $event)">
                              </app-vintage-knob>
                            }

                            <!-- Motion Sense Advanced -->
                            @if (layer.type === 'motion-sense') {
                              <app-vintage-knob
                                [label]="'Speed'"
                                [value]="layer.options.motionSpeed!"
                                [min]="0.5"
                                [max]="3"
                                [step]="0.5"
                                (valueChange)="updateLayerOption(layer.id, 'motionSpeed', $event)">
                              </app-vintage-knob>
                            }

                            <!-- Particles Advanced -->
                            @if (layer.type === 'particles') {
                              <app-vintage-knob
                                [label]="'Count'"
                                [value]="layer.options.particleCount!"
                                [min]="10"
                                [max]="200"
                                [step]="10"
                                (valueChange)="updateLayerOption(layer.id, 'particleCount', $event)">
                              </app-vintage-knob>
                              <app-vintage-knob
                                [label]="'Size'"
                                [value]="layer.options.particleSize!"
                                [min]="1"
                                [max]="10"
                                [step]="1"
                                (valueChange)="updateLayerOption(layer.id, 'particleSize', $event)">
                              </app-vintage-knob>
                              <app-vintage-knob
                                [label]="'Speed'"
                                [value]="layer.options.particleSpeed!"
                                [min]="0.5"
                                [max]="3"
                                [step]="0.5"
                                (valueChange)="updateLayerOption(layer.id, 'particleSpeed', $event)">
                              </app-vintage-knob>
                            }

                            <!-- Flames Advanced -->
                            @if (layer.type === 'flames') {
                              <app-vintage-knob
                                [label]="'Height'"
                                [value]="layer.options.flameHeight!"
                                [min]="0.3"
                                [max]="1"
                                [step]="0.1"
                                (valueChange)="updateLayerOption(layer.id, 'flameHeight', $event)">
                              </app-vintage-knob>
                              <app-vintage-knob
                                [label]="'Spread'"
                                [value]="layer.options.flameSpread!"
                                [min]="0.3"
                                [max]="1"
                                [step]="0.1"
                                (valueChange)="updateLayerOption(layer.id, 'flameSpread', $event)">
                              </app-vintage-knob>
                              <app-vintage-knob
                                [label]="'Turbulence'"
                                [value]="layer.options.flameTurbulence!"
                                [min]="0.1"
                                [max]="1"
                                [step]="0.1"
                                (valueChange)="updateLayerOption(layer.id, 'flameTurbulence', $event)">
                              </app-vintage-knob>
                            }
                          </div>
                        </div>
                      }
                    }
                  }
                  </div>
                } @else {
                  <div class="empty-editor-message">
                    <div class="empty-icon"></div>
                    <p>Select an effect layer above and click <strong>Edit</strong> to configure its properties</p>
                  </div>
                }

                <!-- Advanced Settings + Generate GIF Buttons -->
              <div class="section-divider"></div>
              <div class="gif-actions">
                <button class="btn-secondary" (click)="openGifAdvancedSettings()" style="width: 48%;">
                   Settings
                </button>
                <button class="btn-primary" (click)="downloadAnimatedGif()" 
                        [disabled]="generatingGif()" style="width: 48%;">
                  @if (generatingGif()) {
                    <span> Generating...</span>
                  } @else {
                    <span> Generate</span>
                  }
                </button>
              </div>
            </div>
            <!-- Fin gif-studio-panel -->
          </div>
          <!-- Fin gif-studio-container -->

            <!-- Canvas para modo GIF -->
            <div class="canvas-container">
              <div class="canvas-header">
                <h3>GIF Preview</h3>
                @if (processing()) {
                  <span class="processing-badge">Processing...</span>
                }
              </div>
              <div class="gif-preview-viewer" [class.fit-mode]="gifViewMode() === 'fit'" [class.original-mode]="gifViewMode() === 'original'">
                <!-- Indicador de carga para preview GIF -->
                @if (isGeneratingPreview) {
                  <div class="preview-loading-overlay">
                    <div class="preview-loading-spinner">
                      <div class="spinner-ring"></div>
                      <div class="spinner-text">Generating Preview...</div>
                    </div>
                  </div>
                }
                
                <!-- Controles de zoom para GIF Preview -->
                <div class="canvas-controls-overlay">
                  <div class="zoom-controls">
                    <button class="zoom-btn" (click)="gifZoomOut()" [disabled]="gifZoomLevel() <= 25" title="Zoom Out">−</button>
                    <span class="zoom-level">{{ gifZoomLevel() }}%</span>
                    <button class="zoom-btn" (click)="gifZoomIn()" [disabled]="gifZoomLevel() >= 200" title="Zoom In">+</button>
                    <button class="zoom-btn zoom-reset" (click)="resetGifZoom()" title="Reset Zoom">⊙</button>
                  </div>
                </div>
                
                <div class="gif-preview-scroll-container"
                     [class.can-pan]="gifZoomLevel() > 100"
                     (mousedown)="startGifPan($event)"
                     (mousemove)="updateGifPan($event)"
                     (mouseup)="endGifPan()"
                     (mouseleave)="endGifPan()">
                  <div class="gif-preview-content">
                    <canvas #processedCanvas [style.transform]="'scale(' + (gifZoomLevel() / 100) + ')'"></canvas>
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- Composition Mode Layout (Photoshop style) -->
          @if (compositionMode()) {
            <div class="composition-workspace-layout">
              <!-- Left Toolbar (Photoshop style) -->
              <div class="composition-sidebar-left">
                <app-composition-toolbar
                  (toolChange)="onToolChange($event)"
                  (optionsChange)="onToolOptionsChange($event)">
                </app-composition-toolbar>
              </div>
              
              <!-- Main Canvas Area -->
              <div class="composition-canvas-area">
                <div class="canvas-header">
                  <h3> Composition Canvas</h3>
                  <div class="canvas-info">
                    {{ compositionService.compositionState().canvasWidth }} � 
                    {{ compositionService.compositionState().canvasHeight }}px
                  </div>
                  
                  <!-- Undo/Redo Controls -->
                  <div class="undo-redo-controls">
                    <button 
                      class="btn-undo-redo" 
                      [disabled]="!historyService.canUndo()"
                      (click)="historyService.undo()"
                      [title]="'Undo: ' + (historyService.getUndoDescription() || 'Nothing to undo') + ' (Ctrl+Z)'">
                      <span class="icon"></span>
                      <span class="label">Undo</span>
                    </button>
                    <button 
                      class="btn-undo-redo" 
                      [disabled]="!historyService.canRedo()"
                      (click)="historyService.redo()"
                      [title]="'Redo: ' + (historyService.getRedoDescription() || 'Nothing to redo') + ' (Ctrl+Y)'">
                      <span class="icon"></span>
                      <span class="label">Redo</span>
                    </button>
                    <div class="history-info">
                      {{ historyService.getHistorySize().undo }} / {{ historyService.getHistorySize().redo }}
                    </div>
                  </div>
                </div>
                <app-composition-canvas></app-composition-canvas>
              </div>
              
              <!-- Right Sidebar: Layers Panel (Photoshop style) -->
              <div class="composition-sidebar-right">
                <app-composition-layers></app-composition-layers>
                <app-layer-properties></app-layer-properties>
              </div>
            </div>
          }

          <!-- Modo Imagen: Comparador Before/After -->
          @if (!gifStudioMode() && !compositionMode()) {
            <div class="canvas-header">
              <h3>Image Comparison</h3>
              @if (processing()) {
                <span class="processing-badge">Processing...</span>
              }
            </div>
            
            <div class="comparison-viewer" [class.fit-mode]="viewMode() === 'fit'" [class.original-mode]="viewMode() === 'original'">
              <!-- Indicador de carga para preview -->
              @if (isGeneratingPreview) {
                <div class="preview-loading-overlay">
                  <div class="preview-loading-spinner">
                    <div class="spinner-ring"></div>
                    <div class="spinner-text">Optimizing Preview...</div>
                  </div>
                </div>
              }
              
              <!-- Controles de zoom -->
              <div class="canvas-controls-overlay">
                <div class="zoom-controls">
                  <button class="zoom-btn" (click)="zoomOut()" [disabled]="zoomLevel() <= 25" title="Zoom Out">−</button>
                  <span class="zoom-level">{{ zoomLevel() }}%</span>
                  <button class="zoom-btn" (click)="zoomIn()" [disabled]="zoomLevel() >= 200" title="Zoom In">+</button>
                  <button class="zoom-btn zoom-reset" (click)="resetZoom()" title="Reset Zoom">⊙</button>
                </div>
              </div>
              <div class="comparison-scroll-container" 
                   [class.can-pan]="zoomLevel() > 100"
                   (mousedown)="startCanvasPan($event)"
                   (mousemove)="updateCanvasPan($event)"
                   (mouseup)="endCanvasPan()"
                   (mouseleave)="endCanvasPan()">
                <div class="comparison-container">
                  <!-- Imagen Original (fondo) -->
                  <div class="comparison-layer original-layer">
                    <canvas #originalCompareCanvas [style.transform]="'scale(' + (zoomLevel() / 100) + ')'"></canvas>
                  </div>
                  
                  <!-- Imagen Dithered (revelable) -->
                  <div class="comparison-layer dithered-layer" [style.clip-path]="getClipPath()">
                    <canvas #processedCanvas [style.transform]="'scale(' + (zoomLevel() / 100) + ')'"></canvas>
                  </div>
                  
                  <!-- Slider de divisi�n -->
                  <div class="comparison-slider" 
                       [style.left.%]="sliderPosition()"
                       (mousedown)="startDragging($event)"
                       (touchstart)="startDragging($event)">
                    <div class="slider-line"></div>
                    <div class="slider-handle">
                      <span class="slider-arrow left"></span>
                      <span class="slider-arrow right"></span>
                    </div>
                  </div>
                  
                  <!-- Labels -->
                  <div class="comparison-label left-label">Original</div>
                  <div class="comparison-label right-label">Dithered</div>
                </div>
              </div>
            </div>
          }
        </div>
        <!-- Fin canvas-area -->
        
      </div>
      <!-- Fin editor-content -->
      </div>
      <!-- Fin editor-section -->
    }
    </div>
    <!-- Fin main-content -->
  }
  <!-- End DESKTOP INTERFACE -->
</div>
<!-- End app-container -->

<!-- SHARED MODALS (both mobile and desktop) -->
<!-- Palette Creator Modal -->
@if (showPaletteCreator()) {
  <div class="modal-overlay" (click)="togglePaletteCreator()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Create Custom Palette</h2>
        <button class="btn-close" (click)="togglePaletteCreator()"></button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Palette Name</label>
          <input type="text" class="text-input" placeholder="My Custom Palette" [ngModel]="newPaletteName()" (ngModelChange)="newPaletteName.set($event)">
        </div>

        <div class="form-group">
          <label>Colors (min 2)</label>
          <div class="color-list">
            @for (color of paletteColors(); track $index) {
              <div class="color-item">
                <input type="color" class="color-picker" [ngModel]="color" (ngModelChange)="updatePaletteColor($index, $event)">
                <input type="text" class="color-hex" [ngModel]="color" (ngModelChange)="updatePaletteColor($index, $event)">
                @if (paletteColors().length > 2) {
                  <button class="btn-remove" (click)="removeColorFromPalette($index)"></button>
                }
              </div>
            }
          </div>
          <button class="btn-secondary" (click)="addColorToPalette()" style="width: 100%; margin-top: 8px;">+ Add Color</button>
        </div>

        <div class="custom-palettes-list">
          <h3>Saved Custom Palettes</h3>
          @for (palette of customPalettes(); track palette.id) {
            <div class="palette-item">
              <div class="palette-info">
                <span class="palette-name">{{ palette.name }}</span>
                <div class="palette-colors">
                  @for (color of palette.colors; track $index) {
                    <span class="color-dot" [style.backgroundColor]="color"></span>
                  }
                </div>
              </div>
              <button class="btn-remove" (click)="deleteCustomPalette(palette.id)">Delete</button>
            </div>
          }
          @if (customPalettes().length === 0) {
            <p class="empty-state">No custom palettes yet</p>
          }
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="togglePaletteCreator()">Cancel</button>
        <button class="btn-primary" (click)="saveCustomPalette()">Save Palette</button>
      </div>
    </div>
  </div>
}

<!-- Preset Manager Modal -->
@if (showPresetManager()) {
  <div class="modal-overlay" (click)="togglePresetManager()">
    <div class="modal-content preset-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2> Preset Manager</h2>
        <button class="btn-close" (click)="togglePresetManager()"></button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Save Current Settings</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" class="text-input" placeholder="Preset Name" [ngModel]="newPresetName()" (ngModelChange)="newPresetName.set($event)" style="flex: 1;">
            <button class="btn-primary" (click)="saveCurrentAsPreset()">Save</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="presets-list">
          <h3>Saved Presets</h3>
          @for (preset of presets(); track preset.id) {
            <div class="preset-item">
              <div class="preset-info">
                <span class="preset-name">{{ preset.name }}</span>
                <span class="preset-details">{{ preset.algorithm }} � {{ preset.palette }}</span>
              </div>
              <div class="preset-actions">
                <button class="btn-secondary" (click)="loadPreset(preset.id)">Load</button>
                <button class="btn-remove" (click)="deletePreset(preset.id)"></button>
              </div>
            </div>
          }
          @if (presets().length === 0) {
            <p class="empty-state">No presets saved yet</p>
          }
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="togglePresetManager()">Close</button>
      </div>
    </div>
  </div>
}

<!-- Sprite Uploader Modal -->
@if (showSpriteUploader()) {
  <app-sprite-uploader 
    (close)="showSpriteUploader.set(false)"
    (spriteUpdated)="onSpriteUpdated($event)">
  </app-sprite-uploader>
}

<!-- GIF Loading Modal -->
@if (generatingGif()) {
  <app-gif-loading
    [title]="'Creating Animated GIF'"
    [message]="gifLoadingMessage()"
    [progress]="gifProgress()"
    [waifuSprite]="waifuSpriteUrl()">
  </app-gif-loading>
}

<!-- Particle Editor Modal -->
@if (showParticleEditor()) {
  <div class="modal-overlay" (click)="closeParticleEditor()">
    <div class="modal-content particle-editor-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3> Custom Particle Editor</h3>
        <button class="btn-close" (click)="closeParticleEditor()"></button>
      </div>
      
      <div class="modal-body">
        <div class="particle-editor-container">
          <!-- Canvas para dibujar -->
          <div class="drawing-area">
            <canvas #particleCanvas 
                    width="64" 
                    height="64"
                    (mousedown)="startDrawing($event)"
                    (mousemove)="draw($event)"
                    (mouseup)="stopDrawing()"
                    (mouseleave)="stopDrawing()">
            </canvas>
            <div class="canvas-grid"></div>
          </div>
          
          <!-- Controles de dibujo -->
          <div class="drawing-controls">
            <div class="control-group">
              <label class="control-label">
                <span>Brush Size</span>
                <span class="control-value">{{ particleBrushSize() }}px</span>
              </label>
              <input type="range" min="1" max="8" step="1" class="slider" 
                     [ngModel]="particleBrushSize()" 
                     (ngModelChange)="particleBrushSize.set($event)">
            </div>
            
            <div class="control-group">
              <label class="control-label">
                <span>Brush Color</span>
              </label>
              <div class="color-palette">
                <button class="color-btn" 
                        *ngFor="let color of particleColors" 
                        [style.background]="color"
                        [class.active]="particleBrushColor() === color"
                        (click)="particleBrushColor.set(color)">
                </button>
              </div>
            </div>
            
            <div class="button-group">
              <button class="btn-secondary" (click)="clearParticleCanvas()">
                 Clear
              </button>
              <button class="btn-secondary" (click)="fillParticleCanvas()">
                 Fill
              </button>
            </div>
            
            <div class="saved-particles-section">
              <h4>Saved Particles</h4>
              <div class="saved-particles-grid">
                @for (sprite of savedParticleSprites(); track sprite.id) {
                  <div class="saved-particle-item" 
                       [class.active]="selectedParticleSpriteId() === sprite.id"
                       (click)="loadParticleSprite(sprite.id)">
                    <img [src]="sprite.data" alt="Particle sprite">
                    <button class="btn-delete-sprite" 
                            (click)="deleteParticleSprite(sprite.id); $event.stopPropagation()">
                      
                    </button>
                  </div>
                }
                @if (savedParticleSprites().length === 0) {
                  <p class="empty-message">No saved particles yet</p>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeParticleEditor()">Cancel</button>
        <button class="btn-primary" (click)="saveParticleSprite()"> Save & Use</button>
      </div>
    </div>
  </div>
}

<!-- GIF Advanced Settings Modal -->
@if (showGifAdvancedSettings()) {
  <app-gif-advanced-settings
    [settings]="{ frameCount: gifFrameCount(), frameDelay: getFrameDelay(), loopCount: gifLoopCount() }"
    (settingsChange)="applyGifAdvancedSettings($event)"
    (cancel)="closeGifAdvancedSettings()">
  </app-gif-advanced-settings>
}

<!-- Achievement Notification -->
<app-achievement-notification 
  [event]="achievementService.unlockedAchievement()">
</app-achievement-notification>

<!-- Achievements Panel -->
@if (showAchievements()) {
  <app-achievements-panel></app-achievements-panel>
}

<!-- Gallery -->
@if (showGallery()) {
  <app-gallery 
    (closed)="showGallery.set(false)"
    (settingsApplied)="onGallerySettingsApplied($event)">
  </app-gallery>
}

<!-- Settings -->
@if (showSettings()) {
  <app-settings 
    (closed)="showSettings.set(false)">
  </app-settings>
}

